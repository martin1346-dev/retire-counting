<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <base target="_top">
  <title>V88.8 é€€ä¼‘æ¨ç®—æˆ°æƒ…å®¤</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;500;700&display=swap" rel="stylesheet">
  <style>
    /* === æ‚¨çš„å°ˆæ¥­æ·±è‰²ä¸»é¡Œ CSS === */
    body { background-color: #0a192f; color: #e6f1ff; font-family: 'Noto Sans TC', sans-serif; padding: 10px; margin: 0; }
    .dashboard-container { width: 100%; max-width: 1200px; background: #112240; border-radius: 16px; padding: 15px; margin: 5px auto; border: 1px solid #233554; box-shadow: 0 10px 40px rgba(0,0,0,0.6); }
    .header { text-align: center; border-bottom: 1px solid #233554; padding-bottom: 8px; margin-bottom: 10px; }
    h1 { color: #64ffda; font-size: 22px; margin: 0; }
    .client-info-bar { margin: 5px 0; display: flex; justify-content: center; gap: 15px; font-size: 13px; color: #8892b0; align-items: center;}
    .info-item { background: rgba(100, 255, 218, 0.05); padding: 2px 12px; border-radius: 20px; border: 1px solid rgba(100, 255, 218, 0.1); }
    .highlight { color: #64ffda; font-weight: bold; }
    .control-panel { display: grid; grid-template-columns: 12% 13% 13% 20% 20% 18%; gap: 8px; background: rgba(10, 25, 47, 0.5); padding: 12px; border-radius: 12px; border: 1px solid #233554; align-items: end; }
    .input-label { font-size: 11px; color: #8892b0; margin-bottom: 4px; display: block; white-space: nowrap; }
    .input-field { background: #0a192f; border: 1px solid #64ffda; color: #64ffda; padding: 6px; border-radius: 4px; font-size: 13px; font-weight: bold; text-align: right; width: 100%; box-sizing: border-box; }
    .summary-grid { display: table; width: 100%; border-spacing: 10px 0; margin: 15px 0; table-layout: fixed; }
    .summary-item { display: table-cell; background: rgba(10, 25, 47, 0.6); padding: 12px; border-radius: 10px; text-align: center; border: 1px solid #233554; vertical-align: middle; }
    .sum-value { display: block; font-size: 20px; font-weight: bold; color: #64ffda; font-family: monospace; }
    .main-layout { display: table; width: 100%; border-spacing: 15px 0; table-layout: fixed; }
    .layout-cell { display: table-cell; background: #0f1e36; border-radius: 14px; padding: 15px; border: 1px solid #233554; vertical-align: top; width: 50%; }
    .progress-box { margin: 5px 0; background: #0a192f; border-radius: 10px; padding: 10px; border: 1px solid #233554; }
    .progress-bar-fill { height: 10px; border-radius: 5px; transition: width 0.8s ease-in-out; }
    .advice-section { margin-top: 15px; background: rgba(10, 25, 47, 0.8); border: 2px solid #64ffda; border-radius: 12px; padding: 15px; position: relative; }
    .launch-btn { position: absolute; right: 15px; top: 15px; background: #118ab2; color: #fff; border: none; padding: 8px 15px; border-radius: 4px; font-weight: bold; cursor: pointer; font-size: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.3); transition: background 0.3s; }
    .launch-btn:hover { background: #06d6a0; }
    .p-table { width: 100%; border-collapse: collapse; table-layout: fixed; margin-top: 5px; }
    .p-table th { color: #8892b0; font-size: 11px; text-align: left; padding: 5px; border-bottom: 1px solid #233554; }
    .p-table td { padding: 8px 5px; font-size: 13px; border-bottom: 1px solid #233554; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .metric-value { text-align: right; font-weight: bold; color: #64ffda; font-family: monospace; }
    
    #sim-modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.9); z-index: 9999; overflow-y: auto; backdrop-filter: blur(8px); }
    .sim-modal-content { position: relative; width: 95%; max-width: 1100px; margin: 30px auto; background: #112240; border: 1px solid #64ffda; border-radius: 16px; padding: 25px; box-shadow: 0 20px 50px rgba(0,0,0,0.8); animation: slideDown 0.4s ease-out; }
    @keyframes slideDown { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    .sim-close-btn { position: absolute; top: 20px; right: 25px; background: #ef476f; color: #fff; padding: 5px 15px; border-radius: 20px; font-size: 14px; font-weight: bold; cursor: pointer; border: 1px solid #ef476f; }
    .sim-header { text-align: center; border-bottom: 1px solid #233554; padding-bottom: 15px; margin-bottom: 20px; }
    .sim-main-grid { display: grid; grid-template-columns: 280px 1fr; gap: 20px; }
    .sim-left-panel { background: rgba(10, 25, 47, 0.6); padding: 15px; border-radius: 12px; border: 1px solid #233554; }
    .sim-input-group { margin-bottom: 15px; }
    .sim-input-group label { display: block; color: #8892b0; font-size: 12px; margin-bottom: 5px; }
    .sim-input-group input, .sim-input-group select { width: 100%; background: #0a192f; border: 1px solid #64ffda; color: #64ffda; padding: 8px; border-radius: 4px; font-weight: bold; font-size: 14px; box-sizing: border-box; }
    .sim-divider { border-top: 1px solid #233554; margin: 15px 0; padding-top: 10px; color: #64ffda; font-size: 12px; font-weight: bold; }
    .sim-right-panel { display: flex; flex-direction: column; gap: 15px; }
    .sim-chart-box { background: #0a192f; border: 1px solid #233554; border-radius: 12px; padding: 10px; height: 350px; flex-shrink: 0; }
    .sim-ai-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
    .sim-stat-card { background: #172a45; padding: 15px; border-radius: 8px; border: 1px solid #233554; text-align: center; }
    .sim-stat-val { font-size: 24px; font-weight: bold; color: #fff; margin: 5px 0; }
    .ai-card { background: rgba(100, 255, 218, 0.1); border: 1px solid #64ffda; grid-column: span 2; text-align: left; display: flex; align-items: center; justify-content: space-between; padding: 15px; border-radius: 8px; }
    .ai-suggestion-text { font-size: 14px; color: #e6f1ff; line-height: 1.5; }
    .apply-btn { background: #64ffda; color: #0a192f; border: none; padding: 8px 15px; border-radius: 4px; font-weight: bold; cursor: pointer; font-size: 12px; white-space: nowrap; margin-left: 10px;}
    @media (max-width: 900px) { .sim-main-grid, .sim-ai-grid { grid-template-columns: 1fr; } .ai-card { flex-direction: column; align-items: start; gap: 10px; } .control-panel { grid-template-columns: repeat(3, 1fr); } .main-layout, .layout-cell { display: block; width: 100%; } .launch-btn { position: static; width: 100%; margin-top: 10px; } }

    /* === ç™»å…¥ç‰†å°ˆå±¬æ¨£å¼ === */
    #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #0a192f; z-index: 9999; display: flex; justify-content: center; align-items: center; }
    .login-box { background: #112240; padding: 40px; border-radius: 12px; text-align: center; border: 1px solid #64ffda; box-shadow: 0 10px 30px rgba(0,0,0,0.5); width: 320px; }
    .login-input { background: #0a192f; border: 1px solid #233554; color: #64ffda; padding: 12px; width: 100%; box-sizing: border-box; border-radius: 6px; margin-bottom: 20px; font-size: 16px; text-align: center;}
    .login-btn { background: #64ffda; color: #0a192f; padding: 12px; width: 100%; border: none; border-radius: 6px; font-weight: bold; font-size: 16px; cursor: pointer; transition: 0.3s; }
    .login-btn:hover { background: #06d6a0; }
  </style>
</head>
<body>

<div id="login-overlay">
  <div class="login-box">
    <h2 style="color:#64ffda; margin-top:0;">VIP è²¡å‹™æˆ°ç•¥ç³»çµ±</h2>
    <p style="color:#8892b0; font-size:13px; margin-bottom:20px;">è«‹è¼¸å…¥æ‚¨çš„å°ˆå±¬æˆæ¬Šç¢¼</p>
    <input type="text" id="auth-code" class="login-input" placeholder="è«‹è¼¸å…¥æˆæ¬Šç¢¼ (å¦‚: VIP-888)">
    <button onclick="verifyLogin()" id="login-btn" class="login-btn">ç™»å…¥é©—è­‰</button>
    <div id="login-msg" style="color:#ef476f; margin-top:15px; font-size:13px; font-weight:bold;"></div>
  </div>
</div>

<div id="main-app" style="display: none;">
  <div class="dashboard-container">
    <div class="header">
      <h1>é€€ä¼‘æ¨ç®—æˆ°æƒ…å®¤</h1>
      <div class="client-info-bar">
        <label style="background:#118ab2; color:#fff; padding:4px 15px; border-radius:20px; font-weight:bold; cursor:pointer; font-size:13px;">
          ğŸ“‚ åŒ¯å…¥å®¢æˆ¶è³‡ç”¢ Excel
          <input type="file" id="excel-upload" accept=".xlsx, .xls" style="display:none;" onchange="handleExcelUpload(event)">
        </label>
        <div class="info-item">å®¢æˆ¶ï¼š<span class="highlight" id="show-name">ç­‰å¾…åŒ¯å…¥...</span></div>
        <div class="info-item">ç¾é½¡ï¼š<span class="highlight" id="show-age">--</span></div>
        <div class="info-item">é€€ä¼‘å€’æ•¸ï¼š<span class="highlight" id="show-years">--</span> å¹´</div>
      </div>
      <div class="control-panel">
        <div><span class="input-label">é€€ä¼‘å¹´é½¡</span><input type="number" id="retireAge" class="input-field" value="65"></div>
        <div><span class="input-label">ç´¯ç©å ±é…¬(%)</span><input type="number" id="accRate" class="input-field" value="5.0" step="0.1"></div>
        <div><span class="input-label">æé ˜ç”Ÿæ¯(%)</span><input type="number" id="wdrRate" class="input-field" value="1.0" step="0.1"></div>
        <div><span class="input-label">ç›®æ¨™é‡‘é¡ (TWD)</span><input type="number" id="targetGoal" class="input-field" value="13000000"></div>
        <div><span class="input-label">æœˆæé ˜é¡ (TWD)</span><input type="number" id="expectPension" class="input-field" value="50000"></div>
        <div><span class="input-label">å¹´æ”¶å…¥(ä¼°ç®—)</span><input type="number" id="annualIncome" class="input-field" value="678132"></div>
      </div>
    </div>

    <div class="summary-grid">
      <div class="summary-item">
        <span><span class="retire-label">--</span> æ­²é è¨ˆç¸½è³‡ç”¢</span>
        <span id="stat-total" class="sum-value">$0</span>
        <div id="stat-pension-3" style="font-size:11px; color:#64ffda; margin-top:4px;">--</div>
      </div>
      <div class="summary-item">
        <span>é”æˆç¼ºå£éœ€æœˆå­˜é¡</span>
        <span id="stat-monthly-save" class="sum-value" style="color:#ef476f">$0</span>
        <div id="stat-longevity" style="font-size:11px; color:#ffd166; margin-top:4px;">å¯æ”¯é ˜è‡³ï¼š--</div>
      </div>
    </div>

    <div class="main-layout">
      <div class="layout-cell">
        <div style="font-weight:bold; margin-bottom:10px; font-size:13px;">è³‡ç”¢ç´¯ç©è¶¨å‹¢</div>
        <div style="height: 360px;"><canvas id="assetChart"></canvas></div>
      </div>
      <div class="layout-cell">
        <div style="font-weight:bold; margin-bottom:10px; font-size:13px;">é€€ä¼‘é«”è³ªäº”ç¶­åº¦</div>
        <div class="progress-box">
          <div style="display:flex; justify-content:space-between; font-size:11px; margin-bottom:4px;"><span>æ—¢æœ‰é”æˆç‡</span><span id="p1-val">0%</span></div>
          <div style="background:#233554; height:10px; border-radius:5px; overflow:hidden;"><div id="p1-bar" class="progress-bar-fill" style="width:0%; background:#118ab2"></div></div>
        </div>
        <div style="height: 230px;"><canvas id="radarChart"></canvas></div>
        <table class="p-table" style="margin-top:10px;"><tbody id="metric-body"></tbody></table>
      </div>
    </div>

    <div class="advice-section">
      <button class="launch-btn" onclick="toggleSim(true)">ğŸš€ å•Ÿå‹• AI é€€ä¼‘æ¨¡æ“¬å™¨</button>
      <div id="advice-content"></div>
    </div>
    
    <div style="margin-top:15px; background:#0a192f; border:1px solid #233554; border-radius:12px; padding:20px;">
      <div style="color:#64ffda; font-weight:bold; margin-bottom:8px; font-size:13px;">ä¿å–®æ¸…å–®</div>
      <table class="p-table">
        <thead><tr><th style="width:20%">ä¿å–®è™Ÿç¢¼</th><th style="width:50%">ä¿å–®åç¨±</th><th style="width:30%; text-align:right"><span class="retire-label">--</span>æ­²åƒ¹å€¼</th></tr></thead>
        <tbody id="policy-body"></tbody>
      </table>
    </div>
    <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #233554; text-align: center;">
      <div style="color: #8892b0; font-size: 12px; font-weight: bold;">
        Â© 2026 [æ—é¦¬ä¸] ç‰ˆæ¬Šæ‰€æœ‰ All Rights Reserved.
      </div>
      <div style="color: #4a5568; font-size: 10px; margin-top: 5px;">
        ç³»çµ±ç‰ˆæœ¬ï¼šV88.8 Release | æœ¬å ±å‘Šåƒ…ä¾›è²¡å‹™è¦åŠƒåƒè€ƒï¼Œä¸æ§‹æˆæŠ•è³‡æ‰¿è«¾
      </div>
    </div>
  </div>

  <div id="sim-modal-overlay">
    <div class="sim-modal-content">
      <div class="sim-close-btn" onclick="toggleSim(false)">âŒ è¿”å›æˆ°æƒ…å®¤</div>
      <div class="sim-header">
        <h2 style="color:#64ffda; margin:0;">ğŸ¤– é€€ä¼‘ç¾é‡‘æµå£“åŠ›æ¸¬è©¦ V88.00</h2>
        <div style="color:#8892b0; font-size:13px;">ä¸‰å±¤å¼è³‡é‡‘å †ç–Š | AI æœ€ä½³è§£å»ºè­° (20/80 Rule)</div>
      </div>

      <div class="sim-main-grid">
        <div class="sim-left-panel">
          <div class="sim-divider" style="margin-top:0;">1. å‹ä¿å‹é€€è¨­å®š (åŸºç¤å±¤)</div>
          <div class="sim-input-group"><label>å‹ä¿æŠ•ä¿è–ªè³‡ (Max 45,800)</label><input type="number" id="avgInsSalary" value="45800" oninput="runSimulation()"></div>
          <div class="sim-input-group"><label>å‹ä¿å¹´è³‡</label><input type="number" id="yearsLI" value="25" oninput="runSimulation()"></div>
          <div class="sim-input-group"><label>å‹é€€ç›®å‰ç´¯ç©</label><input type="number" id="currentLP" value="1500000" oninput="runSimulation()"></div>
          <div class="sim-input-group"><label>å‹é€€ææ’¥æœˆè–ª</label><input type="number" id="currentSalary" value="65000" oninput="runSimulation()"></div>
          
          <div class="sim-input-group" style="display:flex; justify-content:space-between; align-items:center;">
              <label style="margin:0">å‹é€€è‡ªæ 6% ?</label>
              <input type="checkbox" id="hasSelfContrib" checked onchange="runSimulation()" style="width:20px; height:20px;">
          </div>
          <div class="sim-input-group">
              <label>å‹é€€é æœŸç¸¾æ•ˆ (%)</label>
              <input type="number" id="lpRate" value="4.0" step="0.1" oninput="runSimulation()">
          </div>

          <div class="sim-divider">2. è‡ªå­˜é€€ä¼‘é‡‘ (é¢¨éšªå±¤)</div>
          <div class="sim-input-group"><label>è‡ªå­˜ç›®æ¨™æœ¬é‡‘</label><input type="number" id="simCapital" value="13000000" oninput="runSimulation()"></div>
          <div class="sim-input-group"><label>æé ˜æœŸå ±é…¬ç‡ (Î¼ %)</label><input type="number" id="simMu" value="1.0" step="0.1" oninput="runSimulation()"></div>
          
          <div class="sim-divider" style="color:#ef476f">3. æé ˜ç›®æ¨™</div>
          <div class="sim-input-group"><label style="color:#ef476f">é€€ä¼‘å¾Œæ¯æœˆç¸½èŠ±è²»</label><input type="number" id="monthlySpend" value="50000" oninput="runSimulation()" style="border-color:#ef476f; color:#ef476f"></div>
          
          <input type="hidden" id="simAgeNow" value="57"><input type="hidden" id="simAgeRetire" value="65">
          <button onclick="runSimulation()" style="background:#64ffda; color:#0a192f; border:none; padding:10px; width:100%; font-weight:bold; margin-top:10px; border-radius:4px; cursor:pointer;">ğŸ”„ é‡æ–°é‹ç®—</button>
        </div>

        <div class="sim-right-panel">
          <div class="sim-chart-box"><canvas id="mcChart"></canvas></div>
          <div class="sim-ai-grid">
            <div class="sim-stat-card"><div style="font-size:12px; color:#8892b0;">å‹ä¿+å‹é€€ (85æ­²å‰)</div><div id="res-base-income" style="font-size:20px; font-weight:bold; color:#ffd166; margin:5px 0;">$0</div><div style="font-size:11px; color:#8892b0;">æ¯æœˆå›ºå®šé ˜</div></div>
            <div class="sim-stat-card" style="padding: 10px 5px;">
    <div style="font-size:11px; color:#8892b0; margin-bottom:6px; letter-spacing:1px;">è³‡ç”¢å­˜çºŒé‡Œç¨‹ç¢‘ (é”æˆç‡)</div>
    <div style="display:flex; justify-content:space-between; gap:4px;">
      
      <div style="flex:1; background:rgba(6, 214, 160, 0.1); border:1px solid rgba(6, 214, 160, 0.4); border-radius:6px; padding:6px 2px;">
        <div style="font-size:10px; color:#06d6a0; margin-bottom:2px;">80 æ­²</div>
        <div id="rate-80" style="font-size:15px; font-weight:bold; color:#06d6a0;">--%</div>
      </div>

      <div style="flex:1; background:rgba(255, 209, 102, 0.1); border:1px solid rgba(255, 209, 102, 0.4); border-radius:6px; padding:6px 2px;">
        <div style="font-size:10px; color:#ffd166; margin-bottom:2px;">90 æ­²</div>
        <div id="rate-90" style="font-size:15px; font-weight:bold; color:#ffd166;">--%</div>
      </div>

      <div style="flex:1; background:rgba(239, 71, 111, 0.1); border:1px solid rgba(239, 71, 111, 0.4); border-radius:6px; padding:6px 2px;">
        <div style="font-size:10px; color:#ef476f; margin-bottom:2px;">100 æ­²</div>
        <div id="rate-100" style="font-size:15px; font-weight:bold; color:#ef476f;">--%</div>
      </div>

    </div>
  </div>
            <div class="ai-card">
              <div><div style="font-weight:bold; color:#64ffda; font-size:13px; margin-bottom:3px;">ğŸ¤– AI æœ€ä½³è§£å»ºè­° (80/20 Rule)</div><div id="ai-suggestion-text" style="font-size:13px; color:#e6f1ff;">åˆ†æä¸­...</div></div>
              <button id="btn-apply-opt" onclick="applyOptimal()" style="display:none; background:#64ffda; color:#0a192f; border:none; padding:5px 10px; border-radius:4px; font-weight:bold; cursor:pointer; font-size:12px; margin-left:10px;">å¥—ç”¨å»ºè­°</button>
            </div>
          </div>
          <button onclick="saveToSheet()" style="background:#118ab2; padding:10px; width:100%; font-weight:bold; color:#fff; border:none; border-radius:4px; cursor:pointer;">è«‹å¥—ç”¨ 80/50 å»ºè­°å¤šæ¬¡è©¦ç®—</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  /* =========================================
     é›²ç«¯ API é–˜é“å¯†ç¢¼é©—è­‰
     ========================================= */
  const API_URL = "https://script.google.com/macros/s/AKfycbwcau_cc1mn01ghf-p7wfyCLDrVEBHJnEq2UJ1Z42_7ztyxjgGgA6wECQgMwegUSyOkBQ/exec"; 

  async function verifyLogin() {
    // ç¢ºä¿é€™è£¡çš„å­—ä¸²å‰å¾Œæ²’æœ‰å¤šé¤˜çš„ç©ºç™½ï¼
    const code = document.getElementById('auth-code').value.trim(); 
    const msgDiv = document.getElementById('login-msg');
    const btn = document.getElementById('login-btn');
    
    if (!code) { msgDiv.innerText = "è«‹å…ˆè¼¸å…¥æ‚¨çš„å°ˆå±¬æˆæ¬Šç¢¼ï¼"; return; }
    
    msgDiv.style.color = "#8892b0";
    msgDiv.innerText = "é€£ç·šé©—è­‰ä¸­ï¼Œè«‹ç¨å€™...";
    btn.innerText = "é©—è­‰ä¸­...";
    btn.disabled = true;

    try {
      // å‡ç´šï¼šæ”¹ç”¨ GET è«‹æ±‚ï¼Œå°‡å¯†ç¢¼æ›åœ¨ç¶²å€å¾Œæ–¹ï¼Œ100% é¿é–‹ Google è·¨åŸŸé˜»æ“‹
      let response = await fetch(API_URL + "?authCode=" + encodeURIComponent(code));
      let result = await response.json();

      if (result.success) {
        document.getElementById('login-overlay').style.display = 'none';
        document.getElementById('main-app').style.display = 'block';
      } else {
        msgDiv.style.color = "#ef476f";
        msgDiv.innerText = result.error;
        btn.innerText = "ç™»å…¥é©—è­‰";
        btn.disabled = false;
      }
    } catch(e) {
      msgDiv.style.color = "#ef476f";
      msgDiv.innerText = "ä¼ºæœå™¨é€£ç·šä¸­æ–·ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚";
      btn.innerText = "ç™»å…¥é©—è­‰";
      btn.disabled = false;
    }
  }

  /* =========================================
     å‰ç«¯è§£æ Excel é‚è¼¯ 
     ========================================= */
  function handleExcelUpload(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
      const data = new Uint8Array(e.target.result);
      const workbook = XLSX.read(data, {type: 'array'});
      const firstSheetName = workbook.SheetNames[0];
      const worksheet = workbook.Sheets[firstSheetName];
      const excelData = XLSX.utils.sheet_to_json(worksheet, {header: 1}); 
      
      if (excelData.length < 2) { alert("Excel æª”æ¡ˆå…§å®¹ç‚ºç©ºæˆ–æ ¼å¼éŒ¯èª¤ï¼"); return; }

      const clientName = excelData[1][16] || "æ¸¬è©¦å®¢æˆ¶"; 
      const birthdayVal = excelData[1][17]; 
      
      const today = new Date();
      let currentAge = 57; 

      if (birthdayVal) {
          let excelEpoch = new Date(1899, 11, 30);
          let actualBirthday = new Date(excelEpoch.getTime() + birthdayVal * 86400000);
          
          if (!isNaN(actualBirthday.getTime())) {
              let age = today.getFullYear() - actualBirthday.getFullYear();
              const m = today.getMonth() - actualBirthday.getMonth();
              if (m < 0 || (m === 0 && today.getDate() < actualBirthday.getDate())) {
                  age--;
              }
              currentAge = age;
          }
      }

      let policyList = [];
      for (let i = 1; i < excelData.length; i++) {
        let row = excelData[i];
        if (!row[1]) continue; 
        
        policyList.push({
          policyNo: row[18], name: row[1], currency: row[2],
          values: [Number(row[3])||0, Number(row[4])||0, Number(row[5])||0, Number(row[6])||0, Number(row[7])||0, Number(row[8])||0],
          remark: row[9], safetyScore: row[10], yieldScore: row[11],
          protectionValue: Number(row[12])||0, totalTerms: Number(row[13])||20, paidYears: Number(row[14])||0, aiAdvice: row[15] || ""
        });
      }

      globalData = { clientName: clientName, currentAge: currentAge, yearsToRetire: 65 - currentAge, policies: policyList };

      document.getElementById('show-name').innerText = globalData.clientName;
      document.getElementById('show-age').innerText = globalData.currentAge + " æ­²";
      document.getElementById('simAgeNow').value = globalData.currentAge;
      document.getElementById('simAgeRetire').value = document.getElementById('retireAge').value;
      
      renderAll(globalData); 
    };
    reader.readAsArrayBuffer(file);
  }

  /* =========================================
     V88.00 Script 
     ========================================= */
  let globalData = null, assetChart = null, radarChartObj = null, simChartInstance = null;
  const COLORS = ['#64ffda', '#118ab2', '#ffd166', '#ef476f', '#06d6a0', '#7209b7'];
  
  let optimalSafeCache = 0; 
  let optimalRiskCache = 0; 

  const vLinePlugin = {
    id: 'vLine',
    afterDraw: (chart) => {
      if (globalData) {
        const {ctx, scales: {x, y}} = chart;
        const rAge = Number(document.getElementById('retireAge').value);
        const yR = Math.max(0, rAge - globalData.currentAge);
        const xPos = x.getPixelForValue(yR / 10);
        ctx.save(); ctx.beginPath(); ctx.setLineDash([5, 5]);
        ctx.moveTo(xPos, y.top); ctx.lineTo(xPos, y.bottom);
        ctx.lineWidth = 1.5; ctx.strokeStyle = '#ffffff'; ctx.stroke();
        ctx.fillStyle = '#ffffff'; ctx.font = '10px Noto Sans TC';
        ctx.fillText('é€€ä¼‘å¹´åº¦', xPos + 5, y.top + 15); ctx.restore();
      }
    }
  };

  // âš ï¸ å·²å®Œç¾ç§»é™¤æ™‚é–“ç‚¸å½ˆï¼Œåƒ…ä¿ç•™å¿…è¦ä¹‹åƒæ•¸å³æ™‚ç›£è½äº‹ä»¶
  window.onload = function() {
    ['targetGoal', 'annualIncome', 'accRate', 'wdrRate', 'expectPension', 'retireAge'].forEach(id => {
      document.getElementById(id).addEventListener('input', () => { if(globalData) renderAll(globalData); });
    });
  };

  function renderAll(data) {
    const rAge = Number(document.getElementById('retireAge').value) || 65;
    const target = Number(document.getElementById('targetGoal').value) || 1;
    const aRate = Number(document.getElementById('accRate').value) / 100;
    const wRate = Number(document.getElementById('wdrRate').value) / 100;
    const expectPMT = Number(document.getElementById('expectPension').value) || 0;
    const income = Number(document.getElementById('annualIncome').value) || 678132;
    const yR = Math.max(0, rAge - data.currentAge);
    
    document.getElementById('show-years').innerText = yR;
    document.querySelectorAll('.retire-label').forEach(el => el.innerText = rAge);

    let totalR = 0, sumS = 0, sumY = 0, totalProt = 0, weightedLiq = 0;
    
    data.policies.forEach((p) => {
      const v = p.values;
      let valAtRetire = 0;
      if (yR <= 1) valAtRetire = v[0];
      else if (yR <= 10) valAtRetire = v[0] + (v[1]-v[0])*((yR-1)/9);
      else {
        const decade = Math.floor(yR/10);
        const idx1 = Math.min(4, decade);
        const idx2 = Math.min(5, decade+1);
        valAtRetire = v[idx1] + (v[idx2]-v[idx1])*((yR%10)/10);
      }
      p._vRetire = valAtRetire * (p.currency === 'USD' ? 30 : 1);
      totalR += p._vRetire; 
      sumS += (Number(p.safetyScore) || 8); 
      sumY += (Number(p.yieldScore) || 5);
      totalProt += (p.protectionValue * (p.currency === 'USD' ? 30 : 1));
      weightedLiq += (Math.min(1, p.paidYears / p.totalTerms) * p._vRetire);
    });
    
    const mAccRate = aRate / 12;
    const gap = Math.max(0, target - totalR);
    let monthlySave = 0;
    
    if (gap > 0 && yR > 0) {
       if (mAccRate <= 0) monthlySave = gap / (yR * 12);
       else monthlySave = gap / ((Math.pow(1 + mAccRate, yR * 12) - 1) / mAccRate);
    }
    
    const mWdrRate = wRate / 12;
    let lonText = "--";
    const simWRate = Math.max(0.00001, mWdrRate); 
    if (expectPMT <= target * simWRate) lonText = "æ°¸çºŒé ˜å–";
    else {
      const denom = expectPMT - (target * simWRate);
      if (denom > 0) {
        let n = Math.log(expectPMT / denom) / Math.log(simWRate + 1);
        lonText = Math.floor(rAge + (n / 12)) + " æ­²";
      } else { lonText = (rAge + 1) + " æ­² (ç«‹å³è€—ç›¡)";
      }
    }

    document.getElementById('stat-total').innerText = `$${Math.round(totalR).toLocaleString()}`;
    document.getElementById('stat-pension-3').innerText = `${(wRate*100).toFixed(1)}% ç”Ÿæ¯ï¼š$${Math.round((target * wRate)/12).toLocaleString()}/æœˆ`;
    document.getElementById('stat-monthly-save').innerText = `$${Math.round(monthlySave).toLocaleString()}`;
    document.getElementById('stat-longevity').innerText = "å¯æ”¯é ˜è‡³ï¼š" + lonText;
    document.getElementById('p1-val').innerText = Math.round((totalR/target)*100) + '%';
    document.getElementById('p1-bar').style.width = Math.min(100, (totalR/target)*100) + '%';
    
    renderAssetChart(data, target, totalR, yR, aRate);
    const avgS = sumS / Math.max(1, data.policies.length);
    const avgY = sumY / Math.max(1, data.policies.length);
    const achSc = Math.min(10, (totalR/target)*10);
    const protSc = Math.min(10, (totalProt / (income * 10)) * 10);
    const liqSc = (weightedLiq / (totalR || 1)) * 10;
    renderRadarChart(avgS, avgY, achSc, protSc, liqSc);
    
    document.getElementById('metric-body').innerHTML = `
      <tr><td>ğŸ›¡ï¸ å®‰å…¨æ€§å¾—åˆ†</td><td class="metric-value">${Math.round(avgS*10)/10} / 10</td></tr>
      <tr><td>ğŸ“ˆ ç²åˆ©æ€§å¾—åˆ†</td><td class="metric-value">${Math.round(avgY*10)/10} / 10</td></tr>
      <tr><td>â˜‚ï¸ å®¶åº­ä¿éšœåº¦</td><td class="metric-value">${Math.round(protSc*10)/10} / 10</td></tr>
      <tr><td>ğŸ’§ è®Šç¾æµå‹•æ€§</td><td class="metric-value">${Math.round(liqSc*10)/10} / 10</td></tr>
    `;
    
    document.getElementById('advice-content').innerHTML = `<div class="advice-card" style="border-left:6px solid #64ffda">
      <h4>ğŸ’¡ CFP å°ˆæ¥­ç²¾ç®—çµè«–</h4>
      <p>ç›®æ¨™æœ¬é‡‘ <b>$${target.toLocaleString()}</b> ä¸‹æ¯æœˆé ˜ <b>$${expectPMT.toLocaleString()}</b> å¯æ”¯é ˜è‡³ <b>${lonText}</b>ã€‚ç›®å‰ç¼ºå£ <b>$${Math.round(gap).toLocaleString()}</b>ï¼Œå»ºè­°æ¯æœˆå„²å­˜ <b>$${Math.round(monthlySave).toLocaleString()}</b>ã€‚</p>
    </div>`;
    
    let tH = "";
    data.policies.forEach((p) => { 
      tH += `<tr><td>${p.policyNo||'æœªç·¨è™Ÿ'}</td><td>${p.name}</td><td style="text-align:right; font-weight:bold; color:#64ffda">$${Math.round(p._vRetire).toLocaleString()}</td></tr>`; 
    });
    document.getElementById('policy-body').innerHTML = tH;
  }

  function renderAssetChart(data, target, totalR, yR, rate) {
    if (assetChart) assetChart.destroy();
    const annualSpend = Number(document.getElementById('expectPension').value) * 12;
    const getComp = (r) => { 
        let dataPoints = [];
        let presentVal = totalR / Math.pow(1 + r, yR);
        for (let t = 0; t <= 60; t += 10) {
            let val = 0;
            if (t <= yR) {
                val = presentVal * Math.pow(1 + r, t);
            } else {
                let postRetireYears = t - yR;
                let balance = totalR;
                for(let k=0; k<postRetireYears; k++){
                    balance = balance * (1 + r) - annualSpend;
                    if(balance < 0) balance = 0;
                }
                val = balance;
            }
            dataPoints.push(val);
        }
        return dataPoints;
    };
    let cum = new Array(7).fill(0);
    let ds = data.policies.map((p, i) => {
      let lyr = [0, ...p.values].map((v, idx) => { cum[idx] += v*(p.currency==='USD'?30:1); return cum[idx]; });
      return { label: p.name, data: lyr, fill: 'origin', backgroundColor: COLORS[i%6]+'cc', pointRadius: 0 };
    });
    ds.push({ label: 'é€€ä¼‘ç›®æ¨™', data: Array(7).fill(target), borderColor: '#ff4d4d', borderWidth: 4, fill: false, pointRadius: 0, order: -100 });
    ds.push({ label: 'ç´¯ç©é æ¸¬ (å«æé ˜)', data: getComp(rate), borderColor: '#ffd166', borderWidth: 2, fill: false, pointRadius: 0 });
    
    assetChart = new Chart(document.getElementById('assetChart'), { type: 'line', data: { labels: ['0å¹´','10å¹´','20å¹´','30å¹´','40å¹´','50å¹´','60å¹´'], datasets: ds }, plugins: [vLinePlugin], options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { color: '#fff', boxWidth: 10 } } }, scales: { y: { beginAtZero: true, ticks: { color: '#fff', font: { size: 10 } }, grid: { color: '#233554' }, suggestedMax: target * 1.1 }, x: { ticks: { color: '#fff', font: { size: 10 } } } } } });
  }

  function renderRadarChart(s, y, a, p, l) {
    if (radarChartObj) radarChartObj.destroy();
    radarChartObj = new Chart(document.getElementById('radarChart'), { type: 'radar', data: { labels: ['å®‰å…¨æ€§','ç²åˆ©æ€§','é”æˆç‡','ä¿éšœåº¦','æµå‹•æ€§'], datasets: [{ data: [s||0, y||0, a||0, p||0, l||0], backgroundColor: 'rgba(100,255,218,0.3)', borderColor: '#64ffda', borderWidth: 2 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { r: { suggestedMin: 0, suggestedMax: 10, pointLabels: { color: '#fff', font: { size: 10 } }, grid: { color: '#233554' }, ticks: { display: false } } }, plugins: { legend: { display: false } } } });
  }

  function toggleSim(show) {
    const overlay = document.getElementById('sim-modal-overlay');
    overlay.style.display = show ? 'block' : 'none';
    if (show) runSimulation();
  }

  function randn_bm() {
    let u = 0, v = 0;
    while(u === 0) u = Math.random();
    while(v === 0) v = Math.random();
    return Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
  }

  function runSimulation() {
    const ageNow = Number(document.getElementById('simAgeNow').value) || 57;
    let ageRetire = Number(document.getElementById('simAgeRetire').value) || 65;
    if (ageRetire > 70) { ageRetire = 70; }
    
    const yearsLI = Number(document.getElementById('yearsLI').value);
    const avgInsSalary = Math.min(Number(document.getElementById('avgInsSalary').value), 45800);
    const currentSalary = Number(document.getElementById('currentSalary').value);
    const lpBalance = Number(document.getElementById('currentLP').value);
    const capital = Number(document.getElementById('simCapital').value);
    const mu = Number(document.getElementById('simMu').value) / 100;
    const sigma = 0.07;
    
    const hasSelf = document.getElementById('hasSelfContrib').checked;
    const lpRate = Number(document.getElementById('lpRate').value) / 100;
    let inputSpend = Number(document.getElementById('monthlySpend').value);
    
    const diff = ageRetire - 65;
    let factor = Math.max(0.8, Math.min(1.2, 1 + (diff * 0.04)));
    const liMonth = Math.round(avgInsSalary * yearsLI * 0.0155 * factor);
    
    const yearsToRetire = Math.max(0, ageRetire - ageNow);
    const contribRate = hasSelf ? 0.12 : 0.06;
    const lpContrib = Math.min(currentSalary, 150000) * contribRate;
    
    let lpFuture = 0;
    if (lpRate === 0) {
         lpFuture = lpBalance + (lpContrib * 12 * yearsToRetire);
    } else {
         lpFuture = lpBalance * Math.pow(1 + lpRate, yearsToRetire) + 
                    (lpContrib * 12 * ((Math.pow(1 + lpRate, yearsToRetire) - 1) / lpRate));
    }
    
    const termYears = 85 - ageRetire;
    let lpMonth = 0;
    if (termYears > 0) {
      const rMonth = mu / 12;
      const nMonth = termYears * 12;
      if (rMonth === 0) lpMonth = lpFuture / nMonth;
      else lpMonth = (lpFuture * rMonth) / (1 - Math.pow(1 + rMonth, -nMonth));
    }
    
    const baseIncome = liMonth + Math.round(lpMonth);
    document.getElementById('res-base-income').innerText = `$${baseIncome.toLocaleString()}`;
    
    let effectiveSpend = Math.max(inputSpend, baseIncome);
    
    const simYears = 100 - ageRetire;
    let trajectories = [];
    
    let count80 = 0;
    let count90 = 0;
    let count100 = 0;

    for (let i = 0; i < 1000; i++) {
      let balance = capital;
      let path = [balance];
      
      let alive80 = (ageRetire >= 80);
      let alive90 = (ageRetire >= 90);
      let alive100 = (ageRetire >= 100);
      
      for (let y = 1; y <= simYears; y++) {
        let age = ageRetire + y;
        let r = mu + sigma * randn_bm();
        balance = balance * (1 + r);
        
        let gap = 0;
        if (effectiveSpend > baseIncome) {
            if (age < 85) gap = effectiveSpend - baseIncome;
            else gap = effectiveSpend - liMonth; 
        } else {
            if (age >= 85 && effectiveSpend > liMonth) gap = effectiveSpend - liMonth;
        }
        
        balance -= (gap * 12);
        if (balance < 0) balance = 0;

        if (age === 80 && balance > 0) alive80 = true;
        if (age === 90 && balance > 0) alive90 = true;
        if (age === 100 && balance > 0) alive100 = true;

        path.push(balance);
      }
      
      if (alive80) count80++;
      if (alive90) count90++;
      if (
